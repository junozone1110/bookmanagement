{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<script type="text/javascript">
(function() {
    // Djangoç®¡ç†ç”»é¢ã®jQueryã‚’ä½¿ç”¨
    var $ = django.jQuery;
    
    $(document).ready(function() {
        // ISBNãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¾Œã«ã€Œæ›¸ç±æƒ…å ±ã‚’å–å¾—ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        var isbnField = $('#id_isbn');
        
        if (isbnField.length) {
            // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
            var buttonHtml = '<div style="margin-top: 10px;">' +
                '<button type="button" id="fetch-book-info-btn" class="button" style="padding: 8px 15px;">' +
                'ğŸ“– ISBNã‹ã‚‰æ›¸ç±æƒ…å ±ã‚’å–å¾—' +
                '</button>' +
                '<span id="fetch-status" style="margin-left: 10px; font-weight: bold;"></span>' +
                '</div>';
            
            isbnField.closest('.form-row').append(buttonHtml);
            
            // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            $('#fetch-book-info-btn').on('click', function() {
                var isbn = isbnField.val().trim();
                var statusSpan = $('#fetch-status');
                var button = $(this);
                
                if (!isbn) {
                    statusSpan.html('<span style="color: #f44336;">âŒ ISBNã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</span>');
                    return;
                }
                
                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                button.prop('disabled', true).text('â³ å–å¾—ä¸­...');
                statusSpan.html('<span style="color: #2196f3;">å–å¾—ä¸­...</span>');
                
                // Ajax ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                $.ajax({
                    url: '/books/api/fetch-book-info/',
                    method: 'GET',
                    data: { isbn: isbn },
                    success: function(response) {
                        if (response.success) {
                            // å–å¾—ã—ãŸæƒ…å ±ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
                            $('#id_title').val(response.data.title);
                            $('#id_author').val(response.data.author);
                            $('#id_publisher').val(response.data.publisher);
                            $('#id_published_date').val(response.data.published_date);
                            $('#id_description').val(response.data.description);
                            $('#id_thumbnail_url').val(response.data.thumbnail_url);
                            
                            statusSpan.html('<span style="color: #4caf50;">âœ… æ›¸ç±æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸï¼</span>');
                            
                            // 3ç§’å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆã™
                            setTimeout(function() {
                                statusSpan.fadeOut(function() {
                                    $(this).html('').show();
                                });
                            }, 3000);
                        } else {
                            statusSpan.html('<span style="color: #f44336;">âŒ ' + response.error + '</span>');
                        }
                    },
                    error: function(xhr) {
                        var errorMsg = 'æ›¸ç±æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        statusSpan.html('<span style="color: #f44336;">âŒ ' + errorMsg + '</span>');
                    },
                    complete: function() {
                        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                        button.prop('disabled', false).html('ğŸ“– ISBNã‹ã‚‰æ›¸ç±æƒ…å ±ã‚’å–å¾—');
                    }
                });
            });
            
            // Enterã‚­ãƒ¼ã§ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
            isbnField.on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#fetch-book-info-btn').click();
                }
            });
        }
    });
})();
</script>
{% endblock %}

